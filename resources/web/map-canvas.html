<html>
  <head>
    <title>Map</title>
    <!--<link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">-->
    <!--<script type= "text/javascript" src= "https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
    <script src= "https://cdnjs.cloudflare.com/ajax/libs/leaflet-realtime/2.1.1/leaflet-realtime.js"></script>
    <script type= "text/javascript" src= "/lib/core.js"></script>
    <style>
      ::-webkit-scrollbar {
	  display: none;
      }
      .content {
	  white-space: nowrap;
	  overflow: hidden;
      }
      
      .map {
	  position: absolute;
	  left:0px;
	  top:0px;
	  right: 250px;
	  bottom: 100px;
	  cursor: crosshair;
      }

      .menu-tag {
	  position: absolute;
	  right: 0px;
	  top: 0px;
	  bottom: 300px;
	  width: 250px;
	  background-color: yellow;
	  overflow-y: scroll;
	  scrollbar-width: none;
      }

      .menu-dotstore {
	  position: absolute;
	  right: 0px;
	  bottom: 100px;
	  width: 250px;
	  height: 200px;
	  background-color: green;
	  overflow-y: scroll;
	  scrollbar-width: none;
      }

      .status {
	  position: absolute;
	  right: 0px;
	  bottom: 0px;
	  left: 0px;
	  height: 100px;
	  background-color: yellow;
	  overflow-y: scroll;
	  scrollbar-width: none;
	  white-space: normal;
	  overflow-wrap: break-word;
      }
    </style>
  </head>
  <body>
    <!--<div id= "overlay" style= "width:20px;height:20px;">A</div>-->
    <div id= "content" class= "content">
      <div id= "map" class= "map"></div>
      <div id= "menu-tag" class= "menu-tag"></div>
      <div id= "menu-dotstore" class= "menu-dotstore">test</div>
      <div id= "status" class= "status"></div>
    </div>
    <script type= "text/javascript">
      var jsonGet = function (url, callback, error) {
	  var xhr = new XMLHttpRequest()
	  xhr.open("GET", url, true);
	  xhr.onreadystatechange = function () {
	      if(xhr.readyState === 4 && xhr.status === 200) {
		  callback (JSON.parse(xhr.responseText))
	      } else {
		  error ()
	      }
	  };
	  xhr.send();
      }

      // specific
      function setStatus (status) {
	  document.getElementById ("status").innerHTML = status
      }

      var mapId = window.location.pathname.split ("/").last()
      var map = L.map("map", {maxBoundsViscosity: 1.0})
      map.setView([45, 0], 4)
      map.setMaxBounds ([[-90,-180],[90,180]])

      jsonGet(
	  "/configuration/" + mapId,
	  function (configuration) {
	      map.setView (
		  [configuration.latitude, configuration.longitude],
		  configuration.zoom)
	  },
	  function () {})
      
      L.tileLayer(
	  "/tile/raster/" + mapId + "/{z}/{x}/{y}",
	  {
	      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
	      maxZoom: 18,
	      bounds:[[-90,-180], [90,180]],
	      noWrap: true
	  }).addTo(map)

      L.GridLayer.MarkerLoader = L.GridLayer.extend({
	  initialize: function(url, options) {
              this._url = url;
              this._markerStore = {};
              L.GridLayer.prototype.initialize.call(this, options);
	      this.on("tileunload", function(tileEvent) {
		  var key = this._tileCoordsToKey(tileEvent.coords)
		  if (this._markerStore[key]) {
		      console.log("remove marker")
		      this._markerStore[key].remove()
		      delete this._markerStore[key]
		  }
		  
		  console.log("remove" + key)
	      })
	  },

	  createTile: function(coords, done) {
              var key = this._tileCoordsToKey(coords);
              var data = {
		  x: coords.x,
		  y: coords.y,
		  z: coords.z
              };
              var tileUrl = L.Util.template(this._url, L.extend(data, this.options));
	      var markerStore = this._markerStore

              fetch(tileUrl).then(function(response) {
		  response.json().then(data => {
		      var markers = data.features.map(function (location) {
			  var id = location.properties.id
			  var tags = location.properties.tags
			      
			  var icon = L.icon({
			      iconUrl: location.properties.pin,
			      iconSize: [25,25],
			      iconAnchor: [12.5,12.5]})
			  var marker = L.marker(
			      [
				  location.geometry.coordinates[1],
				  location.geometry.coordinates[0]],
			      {icon: icon})
			  marker.on (
			      "click",
			      function (e) {
				  setStatus (location.properties.description)
			      })
			  return marker
		      })

		      var group = L.layerGroup(markers)
		      group.addTo(map)
		      markerStore[key] = group
		  
		      done();
		  })});

	      return L.DomUtil.create('div');
	  },

	  /*
	  _removeTile: function(key) {
	      if (this._markerStore[key]) {
		  this._markerStore[key].remove();
		  delete this._markerStore[key];
	      }

              return L.GridLayer.prototype._removeTile(key);
	  }
	  */
      });

      var markerLoader = new L.GridLayer.MarkerLoader(
	  "/tile/vector/" + mapId + "/{z}/{x}/{y}",
	  {
	      maxZoom: 18,
	      bounds: [[-90,-180], [90, 180]],
	      noWrap: true
	  })
      markerLoader.addTo(map)

      map.on (
	"click",
	function (e) {
	    setStatus (
		"{:longitude " + Number (e.latlng.lng).toFixed (5) +
		" :latitude " + Number (e.latlng.lat).toFixed (5)  +
		" <a href='http://openstreetmap.org/#map=18/" + e.latlng.lat + "/" + e.latlng.lng + "' target='_blank'>osm</a>" +
		" <a href='https://preview.ideditor.com/master/#map=18/" + e.latlng.lat + "/" + e.latlng.lng + "' target='_blank'>iD</a>" +
	        " <a href='https://www.mapillary.com/app/?focus=map&lat=" + e.latlng.lat + "&lng=" + e.latlng.lng + "&z=18' target='_blank'>mapillary</a>")
	})

      
      //initialize ();
    </script>
  </body>
</html>
